<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hisab Kitab</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J95YDM55T8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J95YDM55T8');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Serif+Display&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-sans:'DM Sans',sans-serif; --font-serif:'DM Serif Display',serif;
            --bg:#F5F5F7; --bg-card:#FFFFFF; --bg-input:#F2F2F4; --bg-hover:#E8E8EC;
            --border:rgba(0,0,0,0.08); --border-focus:#3B7AFF;
            --text-primary:#1D1D1F; --text-secondary:#48484A; --text-muted:#8E8E93; --text-disabled:#AEAEB2;
            --accent:#3B7AFF; --accent-light:#EBF2FF; --accent-dark:#1A56DB;
            --green:#34C759; --green-light:#EBF9EE; --green-text:#1A7A33; --green-dark:#28A348;
            --red:#FF3B30; --red-light:#FFF0EE; --red-text:#C0170F;
            --amber:#FF9500; --amber-light:#FFF7E6;
            --gulnaz-color:#7C3AED; --gulnaz-light:#F3EEFF;
            --ghazala-color:#D97706; --ghazala-light:#FFF7E6;
            --shadow-xs:0 1px 2px rgba(0,0,0,0.04);
            --shadow-sm:0 2px 8px rgba(0,0,0,0.06),0 0 1px rgba(0,0,0,0.04);
            --shadow-md:0 8px 24px rgba(0,0,0,0.08),0 0 1px rgba(0,0,0,0.04);
            --shadow-lg:0 20px 60px rgba(0,0,0,0.14),0 0 1px rgba(0,0,0,0.06);
            --r-sm:8px; --r-md:12px; --r-lg:16px; --r-xl:20px; --r-2xl:28px;
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
        html,body{height:100%;width:100%;overflow:hidden;}
        body{font-family:var(--font-sans);background:var(--bg);color:var(--text-primary);font-size:15px;line-height:1.5;-webkit-font-smoothing:antialiased;position:fixed;inset:0;}
        ::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.12);border-radius:99px;}
        input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
        input[type=number]{-moz-appearance:textfield;}

        @keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
        @keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(3px)}30%,50%,70%{transform:translateX(-5px)}40%,60%{transform:translateX(5px)}}
        @keyframes entryIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.45}}
        @keyframes successPop{0%{transform:scale(1)}30%{transform:scale(1.06)}100%{transform:scale(1)}}
        @keyframes groupIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        .anim-fade-up{animation:fadeUp 0.45s cubic-bezier(.22,1,.36,1) both;}
        .anim-spin{animation:spin 0.9s linear infinite;}
        .anim-shake{animation:shake 0.6s cubic-bezier(.36,.07,.19,.97) both;}
        .chip label{transition:background 0.15s,border-color 0.15s,color 0.15s,transform 0.15s cubic-bezier(.34,1.56,.64,1);}
        .chip label:active{transform:scale(0.92);}

        /* AUTH */
        #auth-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;background:var(--bg);}
        .auth-card{width:100%;max-width:380px;background:var(--bg-card);border-radius:var(--r-2xl);box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:36px 32px;animation:fadeUp 0.5s cubic-bezier(.22,1,.36,1) both;}
        .auth-logo{width:52px;height:52px;background:linear-gradient(135deg,var(--accent) 0%,#7B5EA7 100%);border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 4px 12px rgba(59,122,255,0.32);}
        .auth-logo svg{width:28px;height:28px;color:white;}
        .auth-title{font-family:var(--font-serif);font-size:28px;color:var(--text-primary);margin-bottom:4px;}
        .auth-sub{font-size:14px;color:var(--text-muted);margin-bottom:28px;}
        .form-group{margin-bottom:12px;}
        .remember-row{display:flex;align-items:center;gap:8px;margin-bottom:16px;}
        .remember-row input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer;}
        .remember-row label{font-size:14px;color:var(--text-secondary);cursor:pointer;}
        .auth-footer{display:flex;align-items:center;justify-content:space-between;margin-top:16px;}
        .link-btn{background:none;border:none;font-family:var(--font-sans);font-size:14px;color:var(--accent);cursor:pointer;font-weight:500;transition:color 0.15s;}
        .link-btn:hover{color:var(--accent-dark);}
        a.contact-link{font-size:17px;font-weight:600;color:var(--accent);display:block;text-align:center;margin:10px 0;text-decoration:none;}

        /* INPUTS */
        .input{width:100%;height:48px;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--r-md);padding:0 14px;font-family:var(--font-sans);font-size:15px;color:var(--text-primary);transition:border-color 0.18s,box-shadow 0.18s,background 0.18s;outline:none;}
        .input::placeholder{color:var(--text-muted);}
        .input:focus{border-color:var(--border-focus);background:#fff;box-shadow:0 0 0 3px rgba(59,122,255,0.12);}
        .amount-wrap{display:flex;align-items:center;background:var(--bg-input);border:1.5px solid transparent;border-radius:var(--r-md);transition:border-color 0.18s,box-shadow 0.18s,background 0.18s;overflow:hidden;}
        .amount-wrap:focus-within{border-color:var(--border-focus);background:#fff;box-shadow:0 0 0 3px rgba(59,122,255,0.12);}
        .amount-prefix{padding:0 4px 0 14px;font-size:22px;font-weight:600;color:var(--text-muted);line-height:1;flex-shrink:0;user-select:none;transition:color 0.18s;}
        .amount-wrap:focus-within .amount-prefix{color:var(--text-primary);}
        .amount-input{flex:1;height:56px;background:transparent;border:none;outline:none;font-family:var(--font-sans);font-size:26px;font-weight:700;color:var(--text-primary);padding:0 14px 0 6px;letter-spacing:-0.02em;}
        .amount-input::placeholder{color:var(--text-disabled);font-weight:400;font-size:22px;}

        /* BUTTONS */
        button{font-family:var(--font-sans);cursor:pointer;border:none;}
        .btn-primary{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--accent);color:#fff;font-size:15px;font-weight:600;letter-spacing:-0.01em;padding:0 20px;height:52px;border-radius:var(--r-md);transition:background 0.18s,transform 0.18s,box-shadow 0.18s;box-shadow:0 2px 8px rgba(59,122,255,0.28);white-space:nowrap;}
        .btn-primary:hover:not(:disabled){background:var(--accent-dark);transform:translateY(-1px);box-shadow:0 4px 16px rgba(59,122,255,0.36);}
        .btn-primary:active:not(:disabled){transform:translateY(0);}
        .btn-primary:disabled{opacity:0.65;cursor:default;transform:none;}
        .btn-primary.btn-success{background:var(--green-dark)!important;box-shadow:0 2px 8px rgba(40,163,72,0.28)!important;animation:successPop 0.4s cubic-bezier(.34,1.56,.64,1);}
        .btn-ghost{display:flex;align-items:center;justify-content:center;gap:6px;background:var(--bg-input);color:var(--text-secondary);font-size:14px;font-weight:500;height:52px;padding:0 18px;border-radius:var(--r-md);transition:background 0.15s,color 0.15s;}
        .btn-ghost:hover{background:var(--bg-hover);color:var(--text-primary);}
        .btn-icon{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;background:transparent;color:var(--text-secondary);transition:background 0.15s,color 0.15s;flex-shrink:0;}
        .btn-icon:hover{background:var(--bg-hover);color:var(--text-primary);}
        .btn-danger-icon{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:var(--red-light);color:var(--red-text);flex-shrink:0;transition:background 0.15s,color 0.15s;}
        .btn-danger-icon:hover{background:var(--red);color:#fff;}

        /* STEP BAR */
        .step-bar{display:flex;align-items:center;margin-bottom:20px;padding:0 2px;}
        .step-item{display:flex;align-items:center;flex:1;}.step-item:last-child{flex:0;}
        .step-col{display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
        .step-circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;transition:background 0.3s,transform 0.3s;position:relative;z-index:1;}
        .step-circle.inactive{background:var(--bg-input);color:var(--text-disabled);}
        .step-circle.active{background:var(--accent);color:#fff;transform:scale(1.1);box-shadow:0 0 0 4px var(--accent-light);}
        .step-circle.done{background:var(--green);color:#fff;}
        .step-circle.done::after{content:'‚úì';position:absolute;font-size:13px;}
        .step-circle.done span{display:none;}
        .step-line{flex:1;height:2px;background:var(--bg-input);margin:0 4px;border-radius:99px;overflow:hidden;position:relative;}
        .step-line-fill{position:absolute;inset:0;background:var(--green);border-radius:99px;transform:scaleX(0);transform-origin:left;transition:transform 0.4s cubic-bezier(.22,1,.36,1);}
        .step-line-fill.filled{transform:scaleX(1);}
        .step-label{font-size:10px;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;margin-top:4px;text-align:center;transition:color 0.3s;}
        .step-label.active{color:var(--accent);}.step-label.done{color:var(--green-text);}.step-label.inactive{color:var(--text-disabled);}

        /* CHIPS */
        .chip-group{display:flex;flex-wrap:wrap;gap:7px;}
        .chip input[type="radio"]{position:absolute;opacity:0;width:0;height:0;}
        .chip label{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 13px;border-radius:99px;background:var(--bg-input);color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;border:1.5px solid transparent;user-select:none;white-space:nowrap;will-change:transform;}
        .chip input[type="radio"]:checked + label{background:var(--accent-light);border-color:var(--accent);color:var(--accent-dark);font-weight:600;}
        .chip label:hover{background:var(--bg-hover);}
        .chip input[type="radio"]:checked + label:hover{background:var(--accent-light);}
        .chip-name label{height:44px;padding:0 20px;font-size:15px;}
        .other-expand-chip{display:inline-flex;align-items:center;gap:6px;height:36px;padding:0 13px;border-radius:99px;background:var(--bg-input);color:var(--text-muted);font-size:13px;font-weight:500;cursor:pointer;border:1.5px dashed var(--border);transition:background 0.15s,border-color 0.15s,color 0.15s,transform 0.15s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;}
        .other-expand-chip:hover{background:var(--bg-hover);border-color:var(--text-muted);color:var(--text-secondary);}
        .other-expand-chip:active{transform:scale(0.92);}
        .other-expand-chip.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent-dark);border-style:solid;font-weight:600;}
        .other-input-wrap{overflow:hidden;max-height:0;opacity:0;transition:max-height 0.35s cubic-bezier(.22,1,.36,1),opacity 0.25s;}
        .other-input-wrap.open{max-height:60px;opacity:1;margin-top:10px;}

        /* FORM SECTIONS */
        .form-section{background:var(--bg-card);border-radius:var(--r-xl);border:1px solid var(--border);box-shadow:var(--shadow-xs);padding:16px;margin-bottom:12px;transition:box-shadow 0.2s;}
        .form-section:focus-within{box-shadow:var(--shadow-sm);}
        .section-label{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;padding:0 2px;}
        .form-actions{display:flex;gap:10px;margin-top:14px;}

        /* APP SHELL */
        #app-container{position:fixed;inset:0;display:flex;flex-direction:column;}
        .app-header{display:flex;align-items:center;padding:10px 14px 8px;padding-top:calc(10px + env(safe-area-inset-top));background:rgba(245,245,247,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);gap:10px;flex-shrink:0;position:relative;z-index:10;}
        .app-header-title{font-family:var(--font-serif);font-size:21px;color:var(--text-primary);flex:1;}
        #main-scroll{flex:1;overflow-y:auto;padding:14px 14px calc(14px + env(safe-area-inset-bottom));}
        .content-wrap{max-width:440px;margin:0 auto;}

        /* RECENT ENTRIES */
        .recent-header{display:flex;align-items:center;justify-content:space-between;margin:20px 0 10px;}
        .recent-title{font-size:17px;font-weight:600;color:var(--text-primary);}
        .entries-card{background:var(--bg-card);border-radius:var(--r-xl);border:1px solid var(--border);box-shadow:var(--shadow-xs);overflow:hidden;}
        .entry-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);animation:entryIn 0.35s cubic-bezier(.22,1,.36,1) both;}
        .entry-item:last-child{border-bottom:none;}
        .entry-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;margin-right:12px;}
        .entry-avatar.gulnaz{background:var(--gulnaz-light);color:var(--gulnaz-color);}
        .entry-avatar.ghazala{background:var(--ghazala-light);color:var(--ghazala-color);}
        .entry-info{flex:1;min-width:0;}
        .entry-name{font-size:13px;font-weight:600;color:var(--text-primary);}
        .entry-tag{font-size:12px;color:var(--text-muted);margin-top:1px;}
        .entry-right{text-align:right;flex-shrink:0;}
        .entry-amount{font-size:15px;font-weight:700;color:var(--green-text);}
        .entry-date{font-size:11px;color:var(--text-disabled);margin-top:2px;}
        .skeleton{background:var(--bg-input);border-radius:6px;animation:pulse 1.4s ease-in-out infinite;}
        .skeleton-entry{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);}
        .skeleton-entry:last-child{border-bottom:none;}
        .sk-avatar{width:36px;height:36px;border-radius:50%;flex-shrink:0;}.sk-lines{flex:1;}

        /* HAMBURGER */
        .hamburger-menu{position:relative;}
        .menu-panel{position:absolute;top:calc(100% + 8px);left:0;width:220px;background:var(--bg-card);border-radius:var(--r-lg);border:1px solid var(--border);box-shadow:var(--shadow-md);padding:8px;transform-origin:top left;transform:scale(0.94) translateY(-6px);opacity:0;pointer-events:none;transition:transform 0.22s cubic-bezier(.22,1,.36,1),opacity 0.18s;z-index:50;}
        .menu-panel.show{transform:scale(1) translateY(0);opacity:1;pointer-events:auto;}
        .menu-user-row{display:flex;align-items:center;justify-content:space-between;padding:8px 10px 10px;border-bottom:1px solid var(--border);margin-bottom:6px;gap:6px;}
        #user-email-display{font-size:12px;color:var(--text-muted);word-break:break-all;line-height:1.4;flex:1;}
        .menu-item{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:var(--r-sm);font-size:14px;font-weight:500;color:var(--text-secondary);background:transparent;text-align:left;transition:background 0.13s,color 0.13s;min-height:40px;}
        .menu-item:hover{background:var(--bg-input);color:var(--text-primary);}
        .menu-item svg{flex-shrink:0;}

        /* MODALS */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.38);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;z-index:80;}
        .modal-sheet{width:100%;max-width:600px;max-height:92dvh;background:var(--bg-card);border-radius:var(--r-2xl) var(--r-2xl) 0 0;border:1px solid var(--border);border-bottom:none;box-shadow:var(--shadow-lg);display:flex;flex-direction:column;animation:sheetUp 0.36s cubic-bezier(.22,1,.36,1) both;overflow:hidden;}
        .sheet-handle{width:36px;height:4px;border-radius:99px;background:var(--bg-hover);margin:10px auto 0;flex-shrink:0;}
        .modal-header{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0;gap:12px;}
        .modal-header .btn-icon{order:-1;}
        .modal-title-group{flex:1;}
        .modal-title{font-size:17px;font-weight:700;color:var(--text-primary);}
        .modal-subtitle{font-size:13px;color:var(--text-muted);margin-top:2px;}
        .modal-body{flex:1;overflow-y:auto;padding:16px;}
        .modal-footer{padding:12px 16px 16px;border-top:1px solid var(--border);flex-shrink:0;}

        /* TX SUMMARY BAR */
        .tx-summary-bar{display:flex;align-items:stretch;border-bottom:1px solid var(--border);flex-shrink:0;overflow:hidden;}
        .tx-summary-cell{flex:1;padding:12px 10px;text-align:center;border-right:1px solid var(--border);}
        .tx-summary-cell:last-child{border-right:none;}
        .tx-summary-label{font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:3px;}
        .tx-summary-value{font-size:15px;font-weight:700;color:var(--text-primary);}
        .tx-summary-value.gulnaz{color:var(--gulnaz-color);}
        .tx-summary-value.ghazala{color:var(--ghazala-color);}
        .tx-summary-value.owed{color:var(--green-text);}

        /* SEARCH TOOLBAR */
        .tx-toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px 12px;border-bottom:1px solid var(--border);flex-shrink:0;}
        .tx-toolbar .input{height:40px;font-size:14px;flex:1;}

        /* DATE-GROUPED ROWS */
        .date-group{animation:groupIn 0.3s cubic-bezier(.22,1,.36,1) both;}
        .date-group-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px 6px;position:sticky;top:0;background:rgba(245,245,247,0.94);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:2;}
        .date-group-label{font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:0.05em;text-transform:uppercase;}
        .tx-row{display:flex;align-items:center;padding:11px 16px;border-bottom:1px solid rgba(0,0,0,0.04);transition:background 0.12s;gap:12px;}
        .tx-row:last-child{border-bottom:none;}
        .tx-row:hover{background:var(--bg);}
        .tx-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;}
        .tx-avatar.gulnaz{background:var(--gulnaz-light);color:var(--gulnaz-color);}
        .tx-avatar.ghazala{background:var(--ghazala-light);color:var(--ghazala-color);}
        .tx-info{flex:1;min-width:0;}
        .tx-name{font-size:13px;font-weight:600;color:var(--text-primary);}
        .tx-tag{display:inline-block;margin-top:2px;background:var(--accent-light);color:var(--accent-dark);font-size:11px;font-weight:600;padding:1px 7px;border-radius:99px;}
        .tx-amount{font-size:15px;font-weight:700;text-align:right;flex-shrink:0;}
        .tx-amount.gulnaz{color:var(--gulnaz-color);}
        .tx-amount.ghazala{color:var(--ghazala-color);}

        /* TALLY CARD */
        .tally-card{background:var(--bg-card);border-radius:var(--r-xl);border:1px solid var(--border);box-shadow:var(--shadow-xs);overflow:hidden;margin-bottom:12px;}
        .tally-row{display:flex;align-items:stretch;}
        .tally-cell{flex:1;padding:14px 16px;display:flex;flex-direction:column;gap:3px;}
        .tally-cell:first-child{border-right:1px solid var(--border);}
        .tally-cell-label{font-size:11px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;color:var(--text-muted);}
        .tally-cell-amount{font-size:20px;font-weight:700;letter-spacing:-0.02em;}
        .tally-cell-amount.gulnaz{color:var(--gulnaz-color);}
        .tally-cell-amount.ghazala{color:var(--ghazala-color);}
        .tally-owed-bar{border-top:1px solid var(--border);padding:11px 16px;display:flex;align-items:center;justify-content:space-between;}
        .tally-owed-label{font-size:13px;font-weight:500;color:var(--text-muted);}
        .tally-owed-value{font-size:15px;font-weight:700;color:var(--green-text);}
        .tally-skeleton .tally-cell-amount{height:20px;width:80px;border-radius:6px;background:var(--bg-input);animation:pulse 1.4s ease-in-out infinite;}

        /* VIEW ALL FOOTER */
        .view-all-btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:13px 16px;border-top:1px solid var(--border);background:transparent;font-family:var(--font-sans);font-size:13px;font-weight:600;color:var(--accent);cursor:pointer;transition:background 0.15s,color 0.15s;}
        .view-all-btn:hover{background:var(--accent-light);color:var(--accent-dark);}
        .view-all-btn svg{transition:transform 0.18s;}
        .view-all-btn:hover svg{transform:translateX(3px);}

        /* LOAD MORE */
        .load-more-group{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;}
        .btn-load-more{height:34px;padding:0 14px;border-radius:99px;background:var(--bg-input);color:var(--text-secondary);font-size:13px;font-weight:500;border:none;cursor:pointer;transition:background 0.15s;}
        .btn-load-more:hover{background:var(--bg-hover);}

        /* HELP */
        .help-section{margin-bottom:24px;}
        .help-section-title{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:12px;}
        .help-icon-wrap{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .help-list{list-style:none;padding:0;display:flex;flex-direction:column;gap:7px;}
        .help-list li{display:flex;align-items:flex-start;gap:8px;font-size:14px;color:var(--text-secondary);line-height:1.5;}
        .help-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:7px;}

        /* TOAST */
        #message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.9);opacity:0;pointer-events:none;z-index:200;min-width:240px;max-width:320px;background:var(--bg-card);border-radius:var(--r-lg);box-shadow:var(--shadow-lg);border:1px solid var(--border);padding:14px 18px;display:flex;align-items:center;gap:10px;transition:opacity 0.2s,transform 0.22s cubic-bezier(.34,1.56,.64,1);}
        #message-box.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
        .msg-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        #message-text{font-size:14px;font-weight:500;color:var(--text-primary);line-height:1.4;}

        .hidden{display:none!important;}
        .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);}
        .w-full{width:100%;} .flex-1{flex:1;}
        iframe{border:none;display:block;}
        @media(max-width:400px){.auth-card{padding:28px 20px;}.form-section{padding:12px;}.tx-summary-cell{padding:10px 8px;}.tx-summary-value{font-size:13px;}}
    </style>
</head>
<body>

<!-- AUTH -->
<div id="auth-container">
    <div class="auth-card">
        <div id="auth-ui">
            <div class="auth-logo"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg></div>
            <h1 class="auth-title">Hisab Kitab</h1>
            <p class="auth-sub">Personal accounting for busy people.</p>
            <form id="login-form">
                <div class="form-group"><input type="email" id="email" placeholder="Email" required class="input"></div>
                <div class="form-group"><input type="password" id="password" placeholder="Password" required class="input"></div>
                <div class="remember-row"><input id="remember-me" type="checkbox" checked><label for="remember-me">Remember me</label></div>
                <button type="submit" id="login-btn" class="btn-primary w-full">
                    <span id="login-text">Sign In</span>
                    <svg id="login-spinner" class="anim-spin hidden" width="18" height="18" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                </button>
            </form>
            <div class="auth-footer">
                <button class="link-btn" id="forgot-password-link">Forgot password?</button>
                <button class="link-btn" id="signup-button">Create account</button>
            </div>
            <p style="text-align:center;font-size:11px;color:var(--text-disabled);margin-top:18px;">Turn off adblocker if unresponsive.</p>
        </div>
        <div id="password-reset-ui" class="hidden">
            <h1 class="auth-title" style="margin-bottom:6px;">Reset Password</h1>
            <p class="auth-sub">We'll send a link to your inbox.</p>
            <form id="password-reset-form">
                <div class="form-group"><input type="email" id="reset-email" placeholder="Email" required class="input"></div>
                <button type="submit" id="reset-btn" class="btn-primary w-full" style="margin-bottom:12px;">
                    <span id="reset-text">Send Reset Link</span>
                    <svg id="reset-spinner" class="anim-spin hidden" width="18" height="18" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                </button>
            </form>
            <button id="reset-go-back-button" class="btn-ghost w-full">‚Üê Back to Sign In</button>
        </div>
        <div id="contact-ui" class="hidden">
            <h1 class="auth-title" style="margin-bottom:6px;">Create Account</h1>
            <p class="auth-sub" style="margin-bottom:20px;">To get access, email us and we'll set you up:</p>
            <a href="/cdn-cgi/l/email-protection#b7dad2f7cdd6ded399d8c1df" class="contact-link"><span class="__cf_email__" data-cfemail="1f727a5f657e767b31706977">[email&#160;protected]</span></a>
            <p class="auth-sub" style="text-align:center;margin-bottom:20px;">You'll be notified once your account is ready.</p>
            <button id="go-back-button" class="btn-ghost w-full">‚Üê Back to Sign In</button>
        </div>
    </div>
</div>

<!-- APP -->
<div id="app-container" class="hidden">
    <header class="app-header">
        <div class="hamburger-menu" id="hamburger-container">
            <button class="btn-icon" id="hamburger-btn" aria-label="Menu">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <div id="menu-content" class="menu-panel">
                <div class="menu-user-row">
                    <span id="user-email-display"></span>
                    <button id="logout-button" class="btn-danger-icon" title="Sign out">
                        <svg id="logout-icon" width="15" height="15" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <svg id="logout-spinner" class="anim-spin hidden" width="14" height="14" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    </button>
                </div>
                <!-- Trend Chart removed from menu ‚ë° -->
                <button class="menu-item" id="help-feedback-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Help
                </button>
            </div>
        </div>
        <h1 class="app-header-title">Hisab Kitab</h1>
    </header>

    <div id="main-scroll">
        <div class="content-wrap">
            <!-- Step bar -->
            <div class="step-bar" style="margin-top:6px;">
                <div class="step-col"><div class="step-circle active" id="step1-circle"><span>1</span></div><div class="step-label active" id="step1-label">Who</div></div>
                <div class="step-item"><div class="step-line"><div class="step-line-fill" id="line1"></div></div></div>
                <div class="step-col"><div class="step-circle inactive" id="step2-circle"><span>2</span></div><div class="step-label inactive" id="step2-label">Amount</div></div>
                <div class="step-item"><div class="step-line"><div class="step-line-fill" id="line2"></div></div></div>
                <div class="step-col"><div class="step-circle inactive" id="step3-circle"><span>3</span></div><div class="step-label inactive" id="step3-label">Category</div></div>
            </div>

            <!-- Tally card -->
            <div class="tally-card tally-skeleton" id="tally-card">
                <div class="tally-row">
                    <div class="tally-cell">
                        <span class="tally-cell-label">Gulnaz</span>
                        <span class="tally-cell-amount gulnaz" id="tally-gulnaz">‚Äî</span>
                    </div>
                    <div class="tally-cell">
                        <span class="tally-cell-label">Ghazala</span>
                        <span class="tally-cell-amount ghazala" id="tally-ghazala">‚Äî</span>
                    </div>
                </div>
                <div class="tally-owed-bar">
                    <span class="tally-owed-label" id="tally-owed-label">Loading‚Ä¶</span>
                    <span class="tally-owed-value" id="tally-owed-value"></span>
                </div>
            </div>

            <form id="data-form" novalidate>
                <!-- Who -->
                <p class="section-label">Who owes?</p>
                <div class="form-section" style="margin-bottom:14px;">
                    <fieldset style="border:none;padding:0;"><legend class="sr-only">Select Name</legend>
                        <div class="chip-group">
                            <div class="chip chip-name"><input type="radio" name="name" id="name-gulnaz" value="Gulnaz Dena"><label for="name-gulnaz">Gulnaz</label></div>
                            <div class="chip chip-name"><input type="radio" name="name" id="name-ghazala" value="Ghazala Dena"><label for="name-ghazala">Ghazala</label></div>
                        </div>
                    </fieldset>
                </div>

                <!-- Amount -->
                <p class="section-label">Amount</p>
                <div class="form-section" style="margin-bottom:14px;padding:8px 12px;">
                    <div class="amount-wrap">
                        <span class="amount-prefix">‚Çπ</span>
                        <input type="number" id="amount" name="amount" placeholder="0" pattern="[0-9]*" inputmode="numeric" class="amount-input">
                    </div>
                </div>

                <!-- Category ‚Äî ‚ë† full updated list -->
                <p class="section-label">Category</p>
                <div class="form-section" style="margin-bottom:16px;">
                    <fieldset style="border:none;padding:0;"><legend class="sr-only">Tag</legend>
                        <div class="chip-group" style="margin-bottom:10px;">
                            <div class="chip"><input type="radio" name="tag" id="tag-kirana"       value="Kirana">       <label for="tag-kirana">üõí Kirana</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-lightbill"    value="Light Bill">   <label for="tag-lightbill">üí° Light Bill</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-society"      value="Society">      <label for="tag-society">üèòÔ∏è Society</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-gosht-kheema" value="Gosht Kheema"> <label for="tag-gosht-kheema">ü•© Gosht Kheema</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-chicken"      value="Chicken">      <label for="tag-chicken">üçó Chicken</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-mutton"       value="Mutton">       <label for="tag-mutton">üêë Mutton</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-kheema"       value="Kheema">       <label for="tag-kheema">ü´ï Kheema</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-bheja"        value="Bheja">        <label for="tag-bheja">üß† Bheja</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-fish"         value="Fish">         <label for="tag-fish">üêü Fish</label></div>
                            <div class="chip"><input type="radio" name="tag" id="tag-gosht"        value="Gosht">        <label for="tag-gosht">üçñ Gosht</label></div>
                            <button type="button" class="other-expand-chip" id="other-chip-btn">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                                Other
                            </button>
                        </div>
                        <div class="other-input-wrap" id="other-input-wrap">
                            <input type="text" id="other-tag-input" name="other-tag" placeholder="Type custom category‚Ä¶" class="input" style="height:42px;font-size:14px;">
                        </div>
                    </fieldset>
                </div>

                <div class="form-actions">
                    <button type="submit" id="submit-button" class="btn-primary flex-1" style="font-size:16px;">
                        <span id="submit-text">Add Entry</span>
                        <svg id="submit-spinner" class="anim-spin hidden" width="18" height="18" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                    </button>
                    <button type="button" id="clear-btn" class="btn-ghost">Clear</button>
                </div>
            </form>

            <div class="recent-header"><span class="recent-title">Recent</span></div>
            <div class="entries-card">
                <div id="recent-entries">
                    <div class="skeleton-entry"><div class="skeleton sk-avatar"></div><div class="sk-lines"><div class="skeleton" style="height:12px;width:100px;margin-bottom:6px;"></div><div class="skeleton" style="height:10px;width:55px;"></div></div></div>
                    <div class="skeleton-entry"><div class="skeleton sk-avatar"></div><div class="sk-lines"><div class="skeleton" style="height:12px;width:120px;margin-bottom:6px;"></div><div class="skeleton" style="height:10px;width:45px;"></div></div></div>
                    <div class="skeleton-entry"><div class="skeleton sk-avatar"></div><div class="sk-lines"><div class="skeleton" style="height:12px;width:90px;margin-bottom:6px;"></div><div class="skeleton" style="height:10px;width:60px;"></div></div></div>
                </div>
                <button type="button" class="view-all-btn" id="view-all-home-btn">
                    View all transactions
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Transactions Modal ‚Äî date-grouped ‚ë¢ -->
    <div id="entries-modal" class="modal-overlay hidden">
        <div class="modal-sheet" style="max-height:95dvh;">
            <div class="sheet-handle"></div>
            <div class="modal-header">
                <button id="close-modal-btn" class="btn-icon">&times;</button>
                <div class="modal-title-group"><h2 class="modal-title">All Transactions</h2></div>
            </div>
            <!-- 3-cell summary bar -->
            <div class="tx-summary-bar" id="tx-summary-bar" style="display:none;">
                <div class="tx-summary-cell"><div class="tx-summary-label">Gulnaz</div><div class="tx-summary-value gulnaz" id="tx-sum-gulnaz">‚Äî</div></div>
                <div class="tx-summary-cell"><div class="tx-summary-label">Ghazala</div><div class="tx-summary-value ghazala" id="tx-sum-ghazala">‚Äî</div></div>
                <div class="tx-summary-cell"><div class="tx-summary-label">Owes</div><div class="tx-summary-value owed" id="tx-sum-owed">‚Äî</div></div>
            </div>
            <div class="tx-toolbar"><input type="text" id="filter-input" placeholder="Search name, category, date‚Ä¶" class="input"></div>
            <div id="entries-table-container" style="flex:1;overflow-y:auto;"></div>
            <div id="load-more-container" class="modal-footer" style="text-align:center;"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-sheet">
            <div class="sheet-handle"></div>
            <div class="modal-header">
                <button id="close-help-modal-btn" class="btn-icon">&times;</button>
                <div class="modal-title-group"><h2 class="modal-title">Help & Feedback</h2></div>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <div class="help-section-title"><div class="help-icon-wrap" style="background:var(--red-light);"><svg width="16" height="16" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>Found a Bug?</div>
                    <ul class="help-list"><li><span class="help-dot" style="background:var(--red);"></span>Contact us with a detailed description</li><li><span class="help-dot" style="background:var(--red);"></span>Include steps to reproduce</li><li><span class="help-dot" style="background:var(--red);"></span>Mention your device</li><li><span class="help-dot" style="background:var(--red);"></span>Share a screenshot if possible</li></ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title"><div class="help-icon-wrap" style="background:var(--green-light);"><svg width="16" height="16" fill="none" stroke="var(--green)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></div>Have Ideas?</div>
                    <ul class="help-list"><li><span class="help-dot" style="background:var(--green);"></span>Share your feature suggestions</li><li><span class="help-dot" style="background:var(--red);"></span>Describe how it would help</li><li><span class="help-dot" style="background:var(--green);"></span>All feedback is considered</li></ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title"><div class="help-icon-wrap" style="background:var(--accent-light);"><svg width="16" height="16" fill="none" stroke="var(--accent)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div>Contact</div>
                    <ul class="help-list"><li><span class="help-dot" style="background:var(--accent);"></span>Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="503d35102a3139347e3f2638">[email&#160;protected]</a></li><li><span class="help-dot" style="background:var(--accent);"></span>Response within 24‚Äì48 hours</li></ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title"><div class="help-icon-wrap" style="background:var(--amber-light);"><svg width="16" height="16" fill="none" stroke="var(--amber)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>Tips</div>
                    <ul class="help-list"><li><span class="help-dot" style="background:var(--amber);"></span>Use "Other" for custom categories</li><li><span class="help-dot" style="background:var(--amber);"></span>Data syncs automatically on submit</li><li><span class="help-dot" style="background:var(--amber);"></span>Turn off adblocker if unresponsive</li><li><span class="help-dot" style="background:var(--amber);"></span>Amounts should be whole numbers</li></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="message-box">
    <div class="msg-icon" id="msg-icon-wrap">
        <svg id="msg-icon-success" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
        <svg id="msg-icon-error" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    </div>
    <p id="message-text"></p>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics }  from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    const c={apiKey:"AIzaSyA5bKSAZN0JHAK_atwbSRz4dCTJ8NaH4vI",authDomain:"auth-demo-9a4bc.firebaseapp.com",projectId:"auth-demo-9a4bc",storageBucket:"auth-demo-9a4bc.firebasestorage.app",messagingSenderId:"554871726025",appId:"1:554871726025:web:ec8d1171f6a85b13c65218",measurementId:"G-J95YDM55T8"};
    getAnalytics(initializeApp(c,'analytics'));
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app=initializeApp({apiKey:"AIzaSyA5bKSAZN0JHAK_atwbSRz4dCTJ8NaH4vI",authDomain:"auth-demo-9a4bc.firebaseapp.com",projectId:"auth-demo-9a4bc",storageBucket:"auth-demo-9a4bc.firebasestorage.app",messagingSenderId:"554871726025",appId:"1:554871726025:web:ec8d1171f6a85b13c65218"});
    const auth=getAuth(app);

    const SCRIPT_URL='https://script.google.com/macros/s/AKfycbwoFc2VyGtJMtFIh2D_qf99BBFLNfQLnFO5MjFv3EtKL3AYYj0C9uNpvmAh-eYy-cisMg/exec';
    const INITIAL_LOAD_COUNT=50;
    let sessionStartTime,allEntries=[],filteredEntries=[],visibleCount=INITIAL_LOAD_COUNT,deviceDetails={};
    let lastSelectedName=null,lastSelectedTag=null,msgTimer=null;

    const trackEvent=(n,p={})=>{if(typeof gtag!=='undefined')gtag('event',n,p);};

    const $=id=>document.getElementById(id);
    const authContainer=$('auth-container'),authUi=$('auth-ui'),contactUi=$('contact-ui'),
          passwordResetUi=$('password-reset-ui'),appContainer=$('app-container'),
          loginForm=$('login-form'),signupButton=$('signup-button'),goBackButton=$('go-back-button'),
          logoutButton=$('logout-button'),userEmailDisplay=$('user-email-display'),
          rememberMeCheckbox=$('remember-me'),forgotPasswordLink=$('forgot-password-link'),
          passwordResetForm=$('password-reset-form'),resetGoBackButton=$('reset-go-back-button'),
          hamburgerBtn=$('hamburger-btn'),menuContent=$('menu-content'),hamburgerContainer=$('hamburger-container');

    hamburgerBtn.addEventListener('click',e=>{e.stopPropagation();menuContent.classList.toggle('show');trackEvent('hamburger_menu_toggle');});
    document.addEventListener('click',e=>{if(!hamburgerBtn.contains(e.target)&&!menuContent.contains(e.target))menuContent.classList.remove('show');});

    const showSpinner=(b,t,s)=>{$(b).disabled=true;$(t).style.display='none';$(s).classList.remove('hidden');};
    const hideSpinner=(b,t,s,txt)=>{$(b).disabled=false;$(t).style.display='';$(t).textContent=txt;$(s).classList.add('hidden');};
    const showLogoutSpinner=()=>{logoutButton.disabled=true;$('logout-icon').classList.add('hidden');$('logout-spinner').classList.remove('hidden');};
    const hideLogoutSpinner=()=>{logoutButton.disabled=false;$('logout-icon').classList.remove('hidden');$('logout-spinner').classList.add('hidden');};

    const showMessage=(msg,isError=true)=>{
        $('message-text').textContent=msg;
        const ok=$('msg-icon-success'),err=$('msg-icon-error'),wrap=$('msg-icon-wrap');
        if(isError){wrap.style.background='var(--red-light)';ok.style.display='none';err.style.display='';err.style.color='var(--red)';}
        else{wrap.style.background='var(--green-light)';ok.style.display='';err.style.display='none';ok.style.color='var(--green)';}
        const mb=$('message-box');mb.classList.add('show');
        if(msgTimer)clearTimeout(msgTimer);
        msgTimer=setTimeout(()=>mb.classList.remove('show'),5000);
        trackEvent(isError?'error_message_shown':'success_message_shown',{message:msg});
    };

    loginForm.addEventListener('submit',async e=>{
        e.preventDefault();const email=e.target.email.value,password=e.target.password.value,rem=rememberMeCheckbox.checked;
        trackEvent('login_attempt',{email});showSpinner('login-btn','login-text','login-spinner');
        try{await setPersistence(auth,rem?browserLocalPersistence:browserSessionPersistence);await signInWithEmailAndPassword(auth,email,password);showMessage('Login successful!',false);trackEvent('login_success',{email});}
        catch(err){showMessage("Oops! Check your password");trackEvent('login_error',{error:err.message});}
        finally{hideSpinner('login-btn','login-text','login-spinner','Sign In');}
    });
    forgotPasswordLink.addEventListener('click',e=>{e.preventDefault();authUi.classList.add('hidden');passwordResetUi.classList.remove('hidden');trackEvent('forgot_password_clicked');});
    passwordResetForm.addEventListener('submit',async e=>{
        e.preventDefault();const email=e.target['reset-email'].value;
        trackEvent('password_reset_attempt',{email});showSpinner('reset-btn','reset-text','reset-spinner');
        try{await sendPasswordResetEmail(auth,email);showMessage("Reset link sent ‚Äî check your inbox!",false);passwordResetForm.reset();trackEvent('password_reset_success',{email});}
        catch(err){showMessage(err.message);trackEvent('password_reset_error',{error:err.message});}
        finally{hideSpinner('reset-btn','reset-text','reset-spinner','Send Reset Link');}
    });
    signupButton.addEventListener('click',()=>{authUi.classList.add('hidden');contactUi.classList.remove('hidden');trackEvent('signup_button_clicked');});
    goBackButton.addEventListener('click',()=>{contactUi.classList.add('hidden');authUi.classList.remove('hidden');trackEvent('go_back_clicked');});
    resetGoBackButton.addEventListener('click',()=>{passwordResetUi.classList.add('hidden');authUi.classList.remove('hidden');trackEvent('reset_go_back_clicked');});
    logoutButton.addEventListener('click',async()=>{
        trackEvent('logout_attempt');showLogoutSpinner();
        try{await signOut(auth);showMessage('Signed out.',false);menuContent.classList.remove('show');trackEvent('logout_success');}
        catch(err){showMessage(err.message);trackEvent('logout_error',{error:err.message});}
        finally{hideLogoutSpinner();}
    });

    onAuthStateChanged(auth,user=>{
        if(user){authContainer.classList.add('hidden');appContainer.classList.remove('hidden');userEmailDisplay.textContent=user.email;trackEvent('user_authenticated',{email:user.email});initApp();}
        else{authContainer.classList.remove('hidden');appContainer.classList.add('hidden');authUi.classList.remove('hidden');contactUi.classList.add('hidden');passwordResetUi.classList.add('hidden');trackEvent('user_signed_out');}
    });

    function initApp(){
        sessionStartTime=new Date();trackEvent('app_initialized');
        const form=$('data-form');
        const otherChipBtn=$('other-chip-btn'),otherInputWrap=$('other-input-wrap'),otherTagInput=$('other-tag-input');
        const clearBtn=$('clear-btn');

        otherChipBtn.addEventListener('click',()=>{
            const open=otherInputWrap.classList.toggle('open');
            otherChipBtn.classList.toggle('active',open);
            if(open){document.querySelectorAll('input[name="tag"]').forEach(r=>r.checked=false);setTimeout(()=>otherTagInput.focus(),50);}
            else otherTagInput.value='';
            updateSteps();trackEvent('other_chip_toggled',{open});
        });
        otherTagInput.addEventListener('input',()=>{
            if(otherTagInput.value.trim())document.querySelectorAll('input[name="tag"]').forEach(r=>r.checked=false);
            updateSteps();trackEvent('other_tag_input_used',{value_length:otherTagInput.value.length});
        });

        clearBtn.addEventListener('click',()=>{
            form.reset();otherInputWrap.classList.remove('open');otherChipBtn.classList.remove('active');otherTagInput.value='';
            if(lastSelectedName){const r=document.querySelector(`input[name="name"][value="${lastSelectedName}"]`);if(r)r.checked=true;}
            if(lastSelectedTag){const r=document.querySelector(`input[name="tag"][value="${lastSelectedTag}"]`);if(r)r.checked=true;}
            updateSteps();$('amount').focus();trackEvent('form_cleared');
        });

        form.addEventListener('submit',handleFormSubmit);
        document.querySelectorAll('input[name="name"],input[name="tag"]').forEach(r=>{
            r.addEventListener('change',()=>{if(r.name==='name')lastSelectedName=r.value;if(r.name==='tag')lastSelectedTag=r.value;updateSteps();});
        });
        $('amount').addEventListener('input',updateSteps);

        $('view-all-home-btn').addEventListener('click',openEntriesModal);
        $('help-feedback-btn').addEventListener('click',()=>{$('help-modal').classList.remove('hidden');hamburgerContainer.classList.add('hidden');menuContent.classList.remove('show');trackEvent('help_feedback_opened');});
        $('close-help-modal-btn').addEventListener('click',()=>{$('help-modal').classList.add('hidden');hamburgerContainer.classList.remove('hidden');trackEvent('help_modal_closed');});
        $('close-modal-btn').addEventListener('click',()=>{$('entries-modal').classList.add('hidden');trackEvent('entries_modal_closed');});
        $('filter-input').addEventListener('input',handleFilter);

        [$('entries-modal'),$('help-modal')].forEach(overlay=>{
            const isHelp=overlay.id==='help-modal';
            let startY=0;const sheet=overlay.querySelector('.modal-sheet');
            sheet.addEventListener('touchstart',e=>{startY=e.touches[0].clientY;},{passive:true});
            sheet.addEventListener('touchend',e=>{
                if(e.changedTouches[0].clientY-startY>80){
                    overlay.classList.add('hidden');
                    if(isHelp)hamburgerContainer.classList.remove('hidden');
                }
            },{passive:true});
        });

        fetchInitialData();getDeviceDetails();
    }

    function updateSteps(){
        const name=document.querySelector('input[name="name"]:checked');
        const amount=$('amount').value.trim();
        const tag=document.querySelector('input[name="tag"]:checked');
        const other=$('other-tag-input').value.trim();
        const s1=!!name,s2=!!amount&&/^\d+$/.test(amount),s3=!!(tag||other);
        setStep(1,s1,true);setStep(2,s2,s1);setStep(3,s3,s2);
        $('line1').classList.toggle('filled',s1);$('line2').classList.toggle('filled',s2);
    }
    function setStep(n,done,active){
        $(`step${n}-circle`).className='step-circle '+(done?'done':active?'active':'inactive');
        $(`step${n}-label`).className='step-label '+(done?'done':active?'active':'inactive');
    }

    const fmt=n=>n?Number(n).toLocaleString('en-IN'):'';

    async function getDeviceDetails(){
        deviceDetails={browserName:'Unknown',osVersion:'Unknown',manufacturer:'Unknown',deviceModel:'Unknown'};
        const ua=navigator.userAgent,pl=navigator.platform;
        if(/Win/.test(pl))deviceDetails.osVersion='Windows';else if(/Mac/.test(pl))deviceDetails.osVersion='MacOS';else if(/Linux/.test(pl))deviceDetails.osVersion='Linux';else if(/iPhone|iPad|iPod/.test(ua))deviceDetails.osVersion='iOS';else if(/Android/.test(ua))deviceDetails.osVersion='Android';
        if(ua.includes('Firefox'))deviceDetails.browserName='Firefox';else if(ua.includes('SamsungBrowser'))deviceDetails.browserName='Samsung Internet';else if(ua.includes('OPR'))deviceDetails.browserName='Opera';else if(ua.includes('Edge'))deviceDetails.browserName='Edge';else if(ua.includes('Chrome'))deviceDetails.browserName='Chrome';else if(ua.includes('Safari'))deviceDetails.browserName='Safari';
        if(navigator.userAgentData){try{const d=await navigator.userAgentData.getHighEntropyValues(['platform','platformVersion','model']);deviceDetails.osVersion=`${d.platform} ${d.platformVersion}`;deviceDetails.deviceModel=d.model||'N/A';}catch(e){}}
        trackEvent('device_details_collected',deviceDetails);
    }

    async function handleFormSubmit(e){
        e.preventDefault();
        const fd=new FormData(e.target);
        const name=fd.get('name'),amount=fd.get('amount');
        const checked=document.querySelector('input[name="tag"]:checked');
        const tag=checked?checked.value:$('other-tag-input').value.trim();
        trackEvent('form_submit_attempt',{name,amount,tag});
        if(!name){showMessage('Please select a name.');return;}
        if(!amount){showMessage('Please enter an amount.');return;}
        if(!/^\d+$/.test(amount)){showMessage('Amount must be a whole number.');return;}
        if(!tag){showMessage('Please select a category.');return;}
        showSpinner('submit-button','submit-text','submit-spinner');
        const userEmail=auth.currentUser?.email||'Unknown';
        const sfd=new FormData();
        sfd.append('name',name);sfd.append('amount',amount);sfd.append('tag',tag);
        sfd.append('sessionDuration',`${Math.round((new Date()-sessionStartTime)/1000)}s`);
        sfd.append('browserName',deviceDetails.browserName);sfd.append('osVersion',deviceDetails.osVersion);
        sfd.append('manufacturer',deviceDetails.manufacturer);sfd.append('deviceModel',deviceDetails.deviceModel);
        sfd.append('userEmail',userEmail);
        try{
            const res=await fetch(SCRIPT_URL,{method:'POST',body:sfd});
            if(!res.ok)throw new Error(res.statusText);
            const data=await res.json();
            if(data.result!=='success')throw new Error(data.error||'Server error.');
            const btn=$('submit-button'),txt=$('submit-text');
            hideSpinner('submit-button','submit-text','submit-spinner','‚úì Saved!');
            btn.classList.add('btn-success');txt.textContent='‚úì Saved!';
            showMessage('Entry added!',false);
            setTimeout(()=>{btn.classList.remove('btn-success');txt.textContent='Add Entry';},1800);
            const sn=document.querySelector('input[name="name"]:checked')?.value||null;
            const st=document.querySelector('input[name="tag"]:checked')?.value||null;
            if(sn)lastSelectedName=sn;if(st)lastSelectedTag=st;
            e.target.reset();$('other-tag-input').value='';$('other-input-wrap').classList.remove('open');$('other-chip-btn').classList.remove('active');
            if(lastSelectedName){const r=document.querySelector(`input[name="name"][value="${lastSelectedName}"]`);if(r)r.checked=true;}
            if(lastSelectedTag){const r=document.querySelector(`input[name="tag"][value="${lastSelectedTag}"]`);if(r)r.checked=true;}
            updateSteps();$('amount').focus();
            fetchInitialData();trackEvent('form_submit_success',{name,amount,tag,user_email:userEmail});
        }catch(err){
            console.error(err);showMessage("Couldn't save. Please contact us.");
            e.target.classList.add('anim-shake');e.target.addEventListener('animationend',()=>e.target.classList.remove('anim-shake'),{once:true});
            hideSpinner('submit-button','submit-text','submit-spinner','Add Entry');
            trackEvent('form_submit_error',{error:err.message});
        }
    }

    function openEntriesModal(){
        $('entries-modal').classList.remove('hidden');
        menuContent.classList.remove('show');
        filteredEntries=[...allEntries];visibleCount=INITIAL_LOAD_COUNT;
        renderGrouped();trackEvent('entries_modal_opened');
    }

    async function fetchInitialData(){
        try{
            const res=await fetch(SCRIPT_URL+'?cacheBust='+Date.now());
            if(!res.ok)throw new Error(res.statusText);
            const data=await res.json();
            if(data.error)throw new Error(data.error);
            allEntries=Array.isArray(data.entries)?data.entries:[];
            renderRecentEntries(allEntries);
            updateHeaderAndSummary(data.summary);
            trackEvent('data_fetch_success',{entries_count:allEntries.length});
        }catch(err){
            console.error(err);
            $('recent-entries').innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:14px;">Could not load entries. Please contact us.</div>';
            trackEvent('data_fetch_error',{error:err.message});
        }
    }

    function updateHeaderAndSummary(summary){
        if(!summary)return;
        // Tally card
        $('tally-gulnaz').textContent=summary.f1?'‚Çπ'+fmt(summary.f1):'‚Çπ0';
        $('tally-ghazala').textContent=summary.g1?'‚Çπ'+fmt(summary.g1):'‚Çπ0';
        const owedName=summary.h1||'';
        const owedAmt=summary.i1?'‚Çπ'+fmt(summary.i1):'‚Çπ0';
        $('tally-owed-label').textContent=owedName?`${owedName} owes`:'Balance';
        $('tally-owed-value').textContent=owedAmt;
        $('tally-card').classList.remove('tally-skeleton');
        // Modal summary bar (keep in sync)
        $('tx-sum-gulnaz').textContent=summary.f1?'‚Çπ'+fmt(summary.f1):'‚Çπ0';
        $('tx-sum-ghazala').textContent=summary.g1?'‚Çπ'+fmt(summary.g1):'‚Çπ0';
        $('tx-sum-owed').textContent=summary.i1?'‚Çπ'+fmt(summary.i1):'‚Çπ0';
        $('tx-summary-bar').style.display='flex';
    }

    function renderRecentEntries(entries){
        const el=$('recent-entries');
        if(!entries.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:14px;">No entries yet.</div>';return;}
        el.innerHTML=entries.slice(0,5).map(([gAmt,zAmt,tag,ts],i)=>{
            const isG=!!gAmt,amount=gAmt||zAmt,name=isG?'Gulnaz':'Ghazala',cls=isG?'gulnaz':'ghazala';
            return `<div class="entry-item" style="animation-delay:${i*55}ms;">
                <div class="entry-avatar ${cls}">${name[0]}</div>
                <div class="entry-info"><div class="entry-name">${name} dena</div><div class="entry-tag">${tag}</div></div>
                <div class="entry-right"><div class="entry-amount">‚Çπ ${fmt(amount)}</div><div class="entry-date">${ts?ts.substring(0,11):''}</div></div>
            </div>`;
        }).join('');
    }

    /* ‚îÄ‚îÄ DATE-GROUPED VIEW ‚ë¢ ‚îÄ‚îÄ */
    function formatDateLabel(ts){
        if(!ts)return 'Unknown Date';
        const d=new Date(ts);if(isNaN(d))return ts.substring(0,11);
        const today=new Date();today.setHours(0,0,0,0);
        const yday=new Date(today);yday.setDate(yday.getDate()-1);
        const e=new Date(d);e.setHours(0,0,0,0);
        if(e.getTime()===today.getTime())return 'Today';
        if(e.getTime()===yday.getTime())return 'Yesterday';
        return d.toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
    }
    function getDayKey(ts){
        if(!ts)return 'unknown';
        const d=new Date(ts);return isNaN(d)?ts.substring(0,10):d.toISOString().substring(0,10);
    }

    function renderGrouped(){
        const container=$('entries-table-container'),loadMore=$('load-more-container');
        if(!filteredEntries.length){container.innerHTML='<p style="padding:24px;text-align:center;color:var(--text-muted);font-size:14px;">No transactions match your search.</p>';loadMore.innerHTML='';return;}

        const sorted=[...filteredEntries].sort((a,b)=>new Date(b[3])-new Date(a[3]));
        const toShow=sorted.slice(0,visibleCount);

        const groups={},order=[];
        toShow.forEach(entry=>{
            const key=getDayKey(entry[3]);
            if(!groups[key]){groups[key]={label:formatDateLabel(entry[3]),entries:[],total:0};order.push(key);}
            groups[key].entries.push(entry);
            groups[key].total+=(parseFloat(entry[0])||0)+(parseFloat(entry[1])||0);
        });

        container.innerHTML=order.map((key,gi)=>{
            const g=groups[key];
            const rows=g.entries.map(([gAmt,zAmt,tag])=>{
                const isG=!!gAmt,amount=gAmt||zAmt,name=isG?'Gulnaz':'Ghazala',cls=isG?'gulnaz':'ghazala';
                return `<div class="tx-row">
                    <div class="tx-avatar ${cls}">${name[0]}</div>
                    <div class="tx-info"><div class="tx-name">${name} dena</div><span class="tx-tag">${tag}</span></div>
                    <div class="tx-amount ${cls}">‚Çπ ${fmt(amount)}</div>
                </div>`;
            }).join('');
            return `<div class="date-group" style="animation-delay:${gi*35}ms;">
                <div class="date-group-header">
                    <span class="date-group-label">${g.label}</span>
                </div>
                <div style="background:var(--bg-card);border-top:1px solid var(--border);">${rows}</div>
            </div>`;
        }).join('');

        renderLoadMore(sorted.length);
    }

    function renderLoadMore(total){
        const c=$('load-more-container');
        if(visibleCount>=total){c.innerHTML=`<p style="font-size:12px;color:var(--text-muted);">All ${total} transactions shown.</p>`;return;}
        const rem=total-visibleCount;
        let html=`<div class="load-more-group"><span style="font-size:12px;color:var(--text-muted);margin-right:4px;">Load:</span>`;
        [50,100,200].filter(v=>rem>=v).forEach(v=>html+=`<button class="btn-load-more" data-amount="${v}">${v}</button>`);
        html+=`<button class="btn-load-more" data-amount="${rem}">All (${rem})</button></div>`;
        c.innerHTML=html;
        c.querySelectorAll('.btn-load-more').forEach(btn=>btn.addEventListener('click',e=>{
            visibleCount+=parseInt(e.currentTarget.dataset.amount,10);renderGrouped();
            trackEvent('load_more_entries',{amount:parseInt(e.currentTarget.dataset.amount,10)});
        }));
    }

    f
